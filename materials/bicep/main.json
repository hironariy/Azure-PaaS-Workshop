{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "14096522552174128781"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for resources"
      }
    },
    "baseName": {
      "type": "string",
      "defaultValue": "blogapp",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Base name for all resources (will be combined with resource type prefix)"
      }
    },
    "groupId": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [
        "",
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J"
      ],
      "metadata": {
        "description": "Workshop group identifier (A-J) for multi-group deployments. Leave empty for single-group."
      }
    },
    "entraTenantId": {
      "type": "string",
      "metadata": {
        "description": "Microsoft Entra ID Tenant ID"
      }
    },
    "entraBackendClientId": {
      "type": "string",
      "metadata": {
        "description": "Microsoft Entra ID Backend API Client ID"
      }
    },
    "entraFrontendClientId": {
      "type": "string",
      "metadata": {
        "description": "Microsoft Entra ID Frontend SPA Client ID - stored in Key Vault for frontend configuration"
      }
    },
    "cosmosDbAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Cosmos DB administrator password"
      }
    },
    "appServiceSku": {
      "type": "string",
      "defaultValue": "B1",
      "allowedValues": [
        "B1",
        "B2",
        "B3",
        "S1",
        "S2",
        "S3",
        "P1v3",
        "P2v3",
        "P3v3"
      ],
      "metadata": {
        "description": "App Service Plan SKU"
      }
    },
    "cosmosDbTier": {
      "type": "string",
      "defaultValue": "M30",
      "allowedValues": [
        "M25",
        "M30",
        "M40",
        "M50"
      ],
      "metadata": {
        "description": "Cosmos DB vCore tier"
      }
    },
    "cosmosDbEnableHa": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Cosmos DB High Availability"
      }
    },
    "staticWebAppSku": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Free",
        "Standard"
      ],
      "metadata": {
        "description": "Static Web Apps SKU"
      }
    },
    "staticWebAppLocation": {
      "type": "string",
      "defaultValue": "eastasia",
      "allowedValues": [
        "westus2",
        "centralus",
        "eastus2",
        "westeurope",
        "eastasia"
      ],
      "metadata": {
        "description": "Static Web Apps location (limited regions available: westus2, centralus, eastus2, westeurope, eastasia)"
      }
    }
  },
  "variables": {
    "tags": {
      "Environment": "[parameters('environment')]",
      "Project": "Azure-PaaS-Workshop",
      "ManagedBy": "Bicep",
      "GroupId": "[if(empty(parameters('groupId')), 'single', parameters('groupId'))]"
    },
    "uniqueSuffix": "[substring(uniqueString(resourceGroup().id, parameters('groupId'), parameters('baseName')), 0, 6)]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3755423324119954429"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, staging, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.1.0.0/16",
              "metadata": {
                "description": "VNet address space"
              }
            },
            "appServiceSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.1.1.0/24",
              "metadata": {
                "description": "App Service VNet Integration subnet CIDR"
              }
            },
            "privateEndpointSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.1.2.0/24",
              "metadata": {
                "description": "Private Endpoint subnet CIDR"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-{0}-{1}', parameters('baseName'), parameters('environment'))]",
            "natGatewayName": "[format('nat-{0}-{1}', parameters('baseName'), parameters('environment'))]",
            "natGatewayPipName": "[format('pip-nat-{0}-{1}', parameters('baseName'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-09-01",
              "name": "[variables('natGatewayPipName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              }
            },
            {
              "type": "Microsoft.Network/natGateways",
              "apiVersion": "2023-09-01",
              "name": "[variables('natGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "idleTimeoutInMinutes": 10,
                "publicIpAddresses": [
                  {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('natGatewayPipName'))]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('natGatewayPipName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-09-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "snet-appservice",
                    "properties": {
                      "addressPrefix": "[parameters('appServiceSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Enabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "natGateway": {
                        "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
                      },
                      "delegations": [
                        {
                          "name": "Microsoft.Web.serverFarms",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "snet-privateendpoint",
                    "properties": {
                      "addressPrefix": "[parameters('privateEndpointSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.mongocluster.cosmos.azure.com",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.mongocluster.cosmos.azure.com', format('link-{0}', variables('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.mongocluster.cosmos.azure.com')]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.vaultcore.azure.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.vaultcore.azure.net', format('link-{0}', variables('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[variables('vnetName')]"
            },
            "appServiceSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-09-01').subnets[0].id]"
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-09-01').subnets[1].id]"
            },
            "cosmosPrivateDnsZoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.mongocluster.cosmos.azure.com')]"
            },
            "keyVaultPrivateDnsZoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
            },
            "natGatewayId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
            },
            "natGatewayPublicIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('natGatewayPipName')), '2023-09-01').ipAddress]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8247076602314119182"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, staging, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Log Analytics retention in days"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "logAnalyticsName": "[format('log-{0}-{1}', parameters('baseName'), parameters('environment'))]",
            "appInsightsName": "[format('appi-{0}-{1}', parameters('baseName'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "Request_Source": "rest",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "DisableIpMasking": false,
                "DisableLocalAuth": false,
                "RetentionInDays": 90
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[variables('logAnalyticsName')]"
            },
            "logAnalyticsWorkspaceCustomerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').customerId]"
            },
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[variables('appInsightsName')]"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "keyVaultPrivateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.keyVaultPrivateDnsZoneId.value]"
          },
          "tenantId": {
            "value": "[parameters('entraTenantId')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7928785523076703939"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, staging, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique resource names"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for Private Endpoint"
              }
            },
            "keyVaultPrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Key Vault"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Tenant ID for access policies"
              }
            },
            "appServicePrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Object ID of App Service Managed Identity (optional - can be set after App Service creation)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('kv-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]",
            "privateEndpointName": "[format('pe-keyvault-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]",
            "keyVaultSecretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[parameters('tenantId')]",
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "publicNetworkAccess": "Disabled",
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices",
                  "ipRules": [],
                  "virtualNetworkRules": []
                }
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "keyvault-connection",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('appServicePrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), parameters('appServicePrincipalId'), variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsUserRoleId'))]",
                "principalId": "[parameters('appServicePrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "cosmosdb-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "cosmosPrivateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.cosmosPrivateDnsZoneId.value]"
          },
          "administratorPassword": {
            "value": "[parameters('cosmosDbAdminPassword')]"
          },
          "tier": {
            "value": "[parameters('cosmosDbTier')]"
          },
          "enableHa": {
            "value": "[parameters('cosmosDbEnableHa')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14502735417150560341"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, staging, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique resource names"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for Private Endpoint"
              }
            },
            "cosmosPrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Cosmos DB"
              }
            },
            "administratorLogin": {
              "type": "string",
              "defaultValue": "blogadmin",
              "metadata": {
                "description": "Administrator login username"
              }
            },
            "administratorPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Administrator login password"
              }
            },
            "tier": {
              "type": "string",
              "defaultValue": "M30",
              "allowedValues": [
                "M25",
                "M30",
                "M40",
                "M50",
                "M60",
                "M80"
              ],
              "metadata": {
                "description": "Cosmos DB vCore tier (M25, M30, M40, M50, M60, M80)"
              }
            },
            "storageSizeGb": {
              "type": "int",
              "defaultValue": 128,
              "metadata": {
                "description": "Disk size in GB"
              }
            },
            "enableHa": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable high availability"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name for storing connection string"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "clusterName": "[format('cosmos-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]",
            "privateEndpointName": "[format('pe-cosmos-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]",
            "connectionString": "[format('mongodb+srv://{0}:{1}@{2}.mongocluster.cosmos.azure.com/?tls=true&authMechanism=SCRAM-SHA-256&retrywrites=false&maxIdleTimeMS=120000', parameters('administratorLogin'), parameters('administratorPassword'), variables('clusterName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/mongoClusters",
              "apiVersion": "2024-02-15-preview",
              "name": "[variables('clusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorPassword')]",
                "serverVersion": "6.0",
                "nodeGroupSpecs": [
                  {
                    "kind": "Shard",
                    "nodeCount": 1,
                    "sku": "[parameters('tier')]",
                    "diskSizeGB": "[parameters('storageSizeGb')]",
                    "enableHa": "[parameters('enableHa')]"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "cosmos-connection",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.DocumentDB/mongoClusters', variables('clusterName'))]",
                      "groupIds": [
                        "MongoCluster"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/mongoClusters', variables('clusterName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('cosmosPrivateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-connection-string')]",
              "properties": {
                "value": "[variables('connectionString')]",
                "contentType": "text/plain"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/mongoClusters', variables('clusterName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-admin-password')]",
              "properties": {
                "value": "[parameters('administratorPassword')]",
                "contentType": "text/plain"
              }
            }
          ],
          "outputs": {
            "clusterId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/mongoClusters', variables('clusterName'))]"
            },
            "clusterName": {
              "type": "string",
              "value": "[variables('clusterName')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            },
            "connectionStringSecretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), 'cosmos-connection-string'), '2023-07-01').secretUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appservice-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "appServiceSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.appServiceSubnetId.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.appInsightsConnectionString.value]"
          },
          "entraTenantId": {
            "value": "[parameters('entraTenantId')]"
          },
          "entraBackendClientId": {
            "value": "[parameters('entraBackendClientId')]"
          },
          "sku": {
            "value": "[parameters('appServiceSku')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7940416640151876704"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, staging, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique resource names"
              }
            },
            "appServiceSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for VNet Integration (outbound)"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name for referencing secrets"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "entraTenantId": {
              "type": "string",
              "metadata": {
                "description": "Microsoft Entra ID Tenant ID"
              }
            },
            "entraBackendClientId": {
              "type": "string",
              "metadata": {
                "description": "Microsoft Entra ID Backend Client ID"
              }
            },
            "swaUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Static Web Apps URL for CORS"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "B1",
              "allowedValues": [
                "B1",
                "B2",
                "B3",
                "S1",
                "S2",
                "S3",
                "P1v3",
                "P2v3",
                "P3v3"
              ],
              "metadata": {
                "description": "App Service Plan SKU"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "appServicePlanName": "[format('asp-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]",
            "appServiceName": "[format('app-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2024-04-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "linux",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[variables('appServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "app,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "publicNetworkAccess": "Enabled",
                "virtualNetworkSubnetId": "[parameters('appServiceSubnetId')]",
                "vnetRouteAllEnabled": true,
                "siteConfig": {
                  "linuxFxVersion": "NODE|22-lts",
                  "alwaysOn": true,
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true,
                  "healthCheckPath": "/health",
                  "appCommandLine": "node src/app.js",
                  "ipSecurityRestrictionsDefaultAction": "Allow",
                  "scmIpSecurityRestrictionsUseMain": true,
                  "scmIpSecurityRestrictionsDefaultAction": "Allow",
                  "appSettings": [
                    {
                      "name": "NODE_ENV",
                      "value": "production"
                    },
                    {
                      "name": "PORT",
                      "value": "8080"
                    },
                    {
                      "name": "WEBSITES_PORT",
                      "value": "8080"
                    },
                    {
                      "name": "COSMOS_CONNECTION_STRING",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=cosmos-connection-string)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "ENTRA_TENANT_ID",
                      "value": "[parameters('entraTenantId')]"
                    },
                    {
                      "name": "ENTRA_CLIENT_ID",
                      "value": "[parameters('entraBackendClientId')]"
                    },
                    {
                      "name": "CORS_ORIGINS",
                      "value": "[parameters('swaUrl')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "XDT_MicrosoftApplicationInsights_NodeJS",
                      "value": "1"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~20"
                    },
                    {
                      "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                      "value": "true"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', variables('appServiceName'), 'ftp')]",
              "properties": {
                "allow": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', variables('appServiceName'), 'scm')]",
              "properties": {
                "allow": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/networkConfig",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', variables('appServiceName'), 'virtualNetwork')]",
              "properties": {
                "subnetResourceId": "[parameters('appServiceSubnetId')]",
                "swiftSupported": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
              ]
            }
          ],
          "outputs": {
            "appServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
            },
            "appServiceName": {
              "type": "string",
              "value": "[variables('appServiceName')]"
            },
            "appServiceDefaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('appServiceName')), '2024-04-01').defaultHostName]"
            },
            "appServicePrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('appServiceName')), '2024-04-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'monitoring-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-rbac-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "keyVaultPrivateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.keyVaultPrivateDnsZoneId.value]"
          },
          "tenantId": {
            "value": "[parameters('entraTenantId')]"
          },
          "appServicePrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appservice-deployment'), '2025-04-01').outputs.appServicePrincipalId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7928785523076703939"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, staging, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique resource names"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for Private Endpoint"
              }
            },
            "keyVaultPrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Key Vault"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Tenant ID for access policies"
              }
            },
            "appServicePrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Object ID of App Service Managed Identity (optional - can be set after App Service creation)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('kv-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]",
            "privateEndpointName": "[format('pe-keyvault-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]",
            "keyVaultSecretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[parameters('tenantId')]",
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "publicNetworkAccess": "Disabled",
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices",
                  "ipRules": [],
                  "virtualNetworkRules": []
                }
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "keyvault-connection",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('appServicePrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), parameters('appServicePrincipalId'), variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsUserRoleId'))]",
                "principalId": "[parameters('appServicePrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appservice-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "staticwebapp-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('staticWebAppLocation')]"
          },
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "sku": {
            "value": "[parameters('staticWebAppSku')]"
          },
          "linkedBackendResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appservice-deployment'), '2025-04-01').outputs.appServiceId.value]"
          },
          "linkedBackendRegion": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4537178054100492999"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, staging, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique resource names"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Free",
              "allowedValues": [
                "Free",
                "Standard"
              ],
              "metadata": {
                "description": "Static Web Apps SKU"
              }
            },
            "linkedBackendResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "App Service resource ID for Linked Backend"
              }
            },
            "linkedBackendRegion": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "App Service region (may differ from SWA location)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "staticWebAppName": "[format('swa-{0}-{1}', parameters('baseName'), parameters('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-01-01",
              "name": "[variables('staticWebAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "[parameters('sku')]"
              },
              "properties": {
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "buildProperties": {
                  "skipGithubActionWorkflowGeneration": true
                }
              }
            },
            {
              "condition": "[and(not(empty(parameters('linkedBackendResourceId'))), equals(parameters('sku'), 'Standard'))]",
              "type": "Microsoft.Web/staticSites/linkedBackends",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('staticWebAppName'), 'backend')]",
              "properties": {
                "backendResourceId": "[parameters('linkedBackendResourceId')]",
                "region": "[parameters('linkedBackendRegion')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', variables('staticWebAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('staticWebAppName'), 'appsettings')]",
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', variables('staticWebAppName'))]"
              ]
            }
          ],
          "outputs": {
            "staticWebAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/staticSites', variables('staticWebAppName'))]"
            },
            "staticWebAppName": {
              "type": "string",
              "value": "[variables('staticWebAppName')]"
            },
            "staticWebAppDefaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/staticSites', variables('staticWebAppName')), '2023-01-01').defaultHostname]"
            },
            "staticWebAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/staticSites', variables('staticWebAppName')), '2023-01-01').defaultHostname)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appservice-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appservice-auth-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appservice-deployment'), '2025-04-01').outputs.appServiceName.value]"
          },
          "entraTenantId": {
            "value": "[parameters('entraTenantId')]"
          },
          "entraBackendClientId": {
            "value": "[parameters('entraBackendClientId')]"
          },
          "staticWebAppDefaultHostName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment'), '2025-04-01').outputs.staticWebAppDefaultHostName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11259939779811537895"
            }
          },
          "parameters": {
            "appServiceName": {
              "type": "string",
              "metadata": {
                "description": "App Service name to configure"
              }
            },
            "entraTenantId": {
              "type": "string",
              "metadata": {
                "description": "Microsoft Entra ID Tenant ID"
              }
            },
            "entraBackendClientId": {
              "type": "string",
              "metadata": {
                "description": "Microsoft Entra ID Backend Client ID"
              }
            },
            "staticWebAppDefaultHostName": {
              "type": "string",
              "metadata": {
                "description": "Static Web App default hostname (for SWA linked backend identity provider)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', parameters('appServiceName'), 'authsettingsV2')]",
              "properties": {
                "platform": {
                  "enabled": true,
                  "runtimeVersion": "~1"
                },
                "globalValidation": {
                  "requireAuthentication": true,
                  "unauthenticatedClientAction": "Return401",
                  "excludedPaths": [
                    "/health",
                    "/api/health",
                    "/robots933456.txt",
                    "/api/posts",
                    "/api/posts/*"
                  ]
                },
                "identityProviders": {
                  "azureActiveDirectory": {
                    "enabled": true,
                    "registration": {
                      "clientId": "[parameters('entraBackendClientId')]",
                      "openIdIssuer": "[format('https://sts.windows.net/{0}/v2.0', parameters('entraTenantId'))]"
                    },
                    "validation": {
                      "allowedAudiences": [
                        "[format('api://{0}', parameters('entraBackendClientId'))]"
                      ]
                    }
                  },
                  "azureStaticWebApps": {
                    "enabled": true,
                    "registration": {
                      "clientId": "[parameters('staticWebAppDefaultHostName')]"
                    }
                  }
                },
                "login": {
                  "tokenStore": {
                    "enabled": false
                  }
                }
              }
            }
          ],
          "outputs": {
            "authSettingsConfigured": {
              "type": "bool",
              "value": true
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appservice-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment')]"
      ]
    }
  ],
  "outputs": {
    "uniqueSuffix": {
      "type": "string",
      "value": "[variables('uniqueSuffix')]"
    },
    "groupId": {
      "type": "string",
      "value": "[parameters('groupId')]"
    },
    "vnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
    },
    "vnetName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetName.value]"
    },
    "natGatewayPublicIp": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.natGatewayPublicIp.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "cosmosDbClusterName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cosmosdb-deployment'), '2025-04-01').outputs.clusterName.value]"
    },
    "appServiceName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appservice-deployment'), '2025-04-01').outputs.appServiceName.value]"
    },
    "appServiceDefaultHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appservice-deployment'), '2025-04-01').outputs.appServiceDefaultHostName.value]"
    },
    "appServiceUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'appservice-deployment'), '2025-04-01').outputs.appServiceDefaultHostName.value)]"
    },
    "staticWebAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment'), '2025-04-01').outputs.staticWebAppName.value]"
    },
    "staticWebAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment'), '2025-04-01').outputs.staticWebAppUrl.value]"
    },
    "apiUrl": {
      "type": "string",
      "value": "[format('{0}/api', reference(resourceId('Microsoft.Resources/deployments', 'staticwebapp-deployment'), '2025-04-01').outputs.staticWebAppUrl.value)]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
    },
    "appInsightsName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.appInsightsName.value]"
    },
    "recommendedResourceGroupName": {
      "type": "string",
      "value": "[if(empty(parameters('groupId')), format('rg-{0}-workshop', parameters('baseName')), format('rg-{0}-{1}-workshop', parameters('baseName'), parameters('groupId')))]"
    }
  }
}