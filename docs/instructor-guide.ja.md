# Azure PaaS ワークショップ - インストラクターガイド

このガイドは、Azure PaaS Workshop を進行するインストラクター向けに、教えどころ、つまずきやすいポイント、ディスカッションの進め方のヒントをまとめたものです。

> **📝 注意:** このドキュメントはインストラクター専用です。受講者はメインの [README.ja.md](../README.ja.md)（必要に応じて [README.md](../README.md)）に従ってください。

---

## 目次

- [ワークショップ概要](#ワークショップ概要)
- [セクション 1: イントロダクション](#セクション-1-イントロダクション)
- [セクション 2: 前提条件とデプロイ](#セクション-2-前提条件とデプロイ)
- [セクション 3: テスト](#セクション-3-テスト)
- [セクション 4: IaaS vs PaaS 比較](#セクション-4-iaas-vs-paas-比較)
- [受講者がつまずきやすいポイント](#受講者がつまずきやすいポイント)
- [時間配分のコツ](#時間配分のコツ)

---

## ワークショップ概要

### 進行形式の例

| 形式 | 時間 | グループ規模 | メモ |
|------|------|--------------|------|
| 対面（講師主導） | 4時間 | 20-45名（10-15グループ） | 推奨 |
| オンライン（講師主導） | 4時間 | 20-45名 | ブレイクアウトルーム推奨 |
| 自習 | 可変 | 個人 | README に沿って進行 |

### 推奨タイムライン（4時間想定）

| 時刻 | 目安 | 内容 |
|------|------|------|
| 0:00 | 20分 | イントロ + 全体像 |
| 0:20 | 60分 | ハンズオン: インフラデプロイ（Steps 1-4） |
| 1:20 | 15分 | 休憩 |
| 1:35 | 60分 | 講師解説: アーキテクチャ / Bicep / 認証 / 監視 |
| 2:35 | 85分 | ハンズオン: アプリデプロイ + 動作確認 |

### IaaS ワークショップ（Day 1）との関係

このワークショップは 2日シリーズの Day 2 として設計されています。

- **Day 1:** [Azure IaaS Workshop](https://github.com/hironariy/Azure-IaaS-Workshop)（VM、LB、手動構成）
- **Day 2:** Azure PaaS Workshop（本ワークショップ。マネージドサービス中心、運用負荷を削減）

Day 1 を終えている参加者が多い場合は、比較ポイント（責任分界、デプロイ手順、ネットワーク、セキュリティ、運用）を随所で意識してもらうと効果的です。

---

## セクション 1: イントロダクション

### 教えどころ

導入では次の点を強調します。

1. **IaaS と PaaS のトレードオフ**
   - IaaS: 自由度が高い一方、運用責任が大きい
   - PaaS: 自由度は一部制約されるが、運用が Microsoft 側でマネージされる

2. **運用負荷の削減**
   - OS パッチ適用が不要
   - 高可用性が標準で組み込まれている
   - オートスケールの機能が使いやすい

3. **PaaS / IaaS の使い分け**
   - PaaS: ステートレスな Web アプリ / API、モダンアプリ
   - IaaS: カスタム OS 要件、レガシー、状態管理が強いアプリ

### よくある質問

| 質問 | 例としての回答 |
|------|----------------|
| 「App Service と VM はいつ使い分ける？」 | ステートレス/ステートフルの観点で説明。App Service はカスタム OS 構成不要な Web/API に向く。 |
| 「PaaS の方が高い？」 | リソース単価だけでなく、運用コスト（人件費/工数/リスク）も含めた TCO で比較する。 |
| 「IaaS から PaaS へ移行できる？」 | 可能。本シリーズは同一アプリを両方式で体験する。論点は DB 移行、接続文字列、デプロイ方法、運用。 |

### ディスカッションの進め方

**テーマ:** 「IaaS と PaaS で何が変わりそう？」

参加者の経験を引き出します。
- これまで使った PaaS（Azure/AWS/その他）
- ベンダーロックインへの懸念
- マネージドサービスの制約や運用に関する疑問

---

## セクション 2: 前提条件とデプロイ

### Entra ID セットアップのつまずきポイント

このパートは最も詰まりやすい箇所です。特に以下を注意して見てください。

1. **Redirect URI の種類が誤り**
   - 「Web」を選んでしまい、SPA にしていない
   - 症状: ログイン時に `AADSTS9002326`
   - 対処: いったん削除して「Single-page application (SPA)」として追加し直す

2. **API 権限の不足**
   - フロントエンドがバックエンド API を呼ぶ権限がない
   - 症状: 403 や “insufficient privileges”
   - 対処: フロントエンド側の「API permissions」で API スコープを付与

3. **スコープ未作成**
   - バックエンド API 側で `access_as_user` スコープが未作成
   - 症状: “Invalid scope”
   - 対処: Backend API → “Expose an API” でスコープ作成

**時短のヒント:** 参加者が Entra ID で詰まる場合、事前にアプリ登録を作って Client ID を配布する運用も検討してください。

### Bicep デプロイ

**目安時間:**
- 初回: 約 10-15 分（DB が最も時間がかかりやすい）
- 2回目以降: 約 3-5 分（差分更新）

**待ち時間に説明するとよい内容:**
1. VNet とサブネット（appservice / privateendpoint）
2. DB と Private Endpoint（Public からアクセス不可）
3. Key Vault と Private Endpoint（シークレット保管）
4. App Service + VNet Integration（プライベートリソースへ接続）
5. Static Web Apps（空で作成され、後でフロントをデプロイ）

**よくあるエラー:**

| エラー | 原因 | 対処 |
|------|------|------|
| “Missing parameter” | Entra ID の値が不足 | `dev.local.bicepparam` を確認 |
| “Invalid password format” | パスワード要件不足 | 英数字+記号で生成 |
| “Name already exists” | 名前衝突 | チームごとに RG 名を分ける / groupId を使う |

### アプリデプロイ

**バックエンド:**
- スクリプト自体は ~2-3分
- 初回起動は 60-90 秒かかることがある（VNet + Key Vault 参照の解決）
- ヘルスチェックが落ちても、少し待って再試行で回復することが多い

**フロントエンド:**
- デプロイ時に runtime config を `index.html` へ注入（セキュリティ上の設計）
- SWA CLI がビルド済み成果物をアップロード
- Linked Backend が `/api/*` を App Service へプロキシ

---

## セクション 3: テスト

### つまずきポイント

| 事象 | 原因 | 対処 |
|------|------|------|
| API が 401 | Linked Backend 未設定 | Azure Portal で SWA 設定を確認 |
| CORS エラー | 本来は起きにくい（Linked Backend 前提） | SWA と App Service のリンク設定確認 |
| ログイン後のリダイレクト失敗 | Redirect URI 不足 | Entra ID のフロントアプリに SWA URL を追加 |
| ログイン後に “No account” | MSAL キャッシュ問題 | キャッシュ削除 / シークレットウィンドウで再試行 |

### 確認チェックリスト

- [ ] 直接ヘルスチェック: `https://<app-service>.azurewebsites.net/health` が 200
- [ ] SWA 経由: `https://<swa>.azurestaticapps.net/api/health` が 200
- [ ] フロントがコンソールエラーなしで表示
- [ ] Microsoft アカウントでサインインできる
- [ ] 投稿の作成/編集/削除ができる

---

## セクション 4: IaaS vs PaaS 比較

### 教えどころ（アーキテクチャ）

1. **Static Web Apps + Linked Backend**
   - `/api/*` を App Service へプロキシ
   - API 保護のために Application Gateway が不要
   - SSL 証明書が自動管理

2. **Private Endpoints**
   - DB/Key Vault はインターネットへ公開されない
   - App Service はプライベート IP 経由でアクセス
   - IaaS では VM が VNet 内のプライベート IP を直接利用していた点と比較

3. **VNet Integration**
   - App Service がプライベートリソースへアクセス可能
   - Outbound が NAT Gateway を経由
   - IaaS の VM と責任分界を比較

4. **Managed Identity**
   - コードに資格情報を埋め込まない
   - App Service が Key Vault に自動で認証
   - IaaS ではスクリプトが Key Vault から取得する運用と対比

### コード差分のディスカッション

1. **DB 接続**
   - IaaS: MongoDB レプリカセット（IP を明示）
   - PaaS: `mongodb+srv://` + TLS 必須

2. **設定の読み込み**
   - IaaS: Nginx が `/config.json` を配信（Bicep 生成）
   - PaaS: デプロイ時に `index.html` へ注入（より安全）

3. **API ルーティング**
   - IaaS: Application Gateway が VM へルーティング
   - PaaS: SWA Linked Backend が App Service へプロキシ

### ディスカッションの進め方

**テーマ 1:** 「どんな時に IaaS を選ぶ？」

期待される回答例:
- カスタム OS 要件（特定カーネル等）
- ローカルディスク前提のステートフル
- レガシー依存
- 特定ハードウェア（GPU、大容量メモリ等）
- 専用基盤が求められる規制要件

**テーマ 2:** 「マネージドサービスのトレードオフは？」

- 自由度低下 vs 運用負荷削減
- ロックイン懸念 vs 立ち上げ速度
- 予算/コストの見え方
- カスタマイズ制約 vs ベストプラクティス既定

**テーマ 3:** 「IaaS → PaaS の移行はどう進める？」

- ステートレス/ステートフルの切り分け
- DB 移行の検討
- 接続文字列/設定の変更計画
- 段階移行（ハイブリッド）

---

## 受講者がつまずきやすいポイント

- Entra ID の Redirect URI 種別（SPA）
- API 権限付与とスコープ作成
- 初回起動の遅さ（VNet/Key Vault の影響）
- SWA の Linked Backend 設定ミス

---

## 時間配分のコツ

- Entra ID は最初に時間を確保（詰まりやすい）
- Bicep デプロイ中は講師解説を入れて待ち時間を活用
- 初回のバックエンド起動遅延は「正常範囲」と事前に共有
